{% extends "base.html" %} {% block body %}


{% set generos_unicos = [] %}
{% for p in peliculas %}
    {% if p.genero not in generos_unicos %}
        {% set _ = generos_unicos.append(p.genero) %}
    {% endif %}
{% endfor %}

<body
  class="text-white bg-gradient-to-b from-gray-900 to-black text-gray-200 font-sans min-h-screen">
  <div class="fixed inset-0 backdrop-blur-[5px] bg-black/20"></div>
  
  <div class="relative z-10 mb-[5%]">
  <section class="secciones mt-32 flex flex-col z-100">
    <h2 class="titulo text-[275%] px-6 font-bold ml-[5%] mb-8" style="text-shadow: 0 0 2px #a10000, 0 0 4px #a10000, 0 0 6px #a10000;">
        
      PEL√çCULAS EN CARTELERA
    </h2>

    <div class="max-w-7xl mx-auto w-full px-4 mt-12 bg-[#1f1f1f] rounded-xl border border-[#c50000]">
    <div class="w-64 mb-8 mt-8">
    <label class="block text-gray-300 mb-2 font-semibold ml-10">Filtrar por g√©nero</label>
    
    <select id="filtroGenero" 
            class="w-full bg-[rgb(44,44,44)] text-gray-200 border border-[rgb(112,0,0)] rounded-lg px-3 py-2 ml-10">
        <option value="todos">Todos los g√©neros</option>

        {% for genero in generos_unicos %}
            <option value="{{ genero }}">{{ genero }}</option>
        {% endfor %}
    </select>
    </div>

    <div
      class="cards-peliculas grid gap-2 justify-items-center gap-y-12 max-w-7xl mx-auto px-4 py-10 gap-x-5
      grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
      {% for p in peliculas %}
      <div
        class="card-pelicula pelicula-cartelera cursor-pointer {% if loop.index > 8 %} hidden extra-pelicula {% endif %} hover:-translate-y-2 transition"
        data-titulo="{{ p.titulo }}"
        data-duracion="{{ p.duracion }}"
        data-sinopsis="{{ p.sinopsis }}"
        data-director="{{ p.director }}"
        data-genero="{{ p.genero }}"
        data-id="{{ p.id_pelicula }}"
        data-img="{{ url_for('static', filename=(p.imagen_url if p.imagen_url else 'img/DefaultM.jpeg')) }}"
      >
        <div class="relative">
        <img src="{{ url_for('static', filename=(p.imagen_url if p.imagen_url else 'img/DefaultM.jpeg')) }}" alt="{{ p.titulo }}"
        class="img-card w-full max-w-[350px] h-[450px] object-cover rounded-t-2xl shadow-lg">
        <p class="absolute top-2 right-2 bg-black/60 text-white text-sm px-2 py-1 rounded-md">‚è± {{ p['duracion'] }}'</p>
        </div>
      <div class="text-white w-full h-35 rounded-b-2xl shadow-md bg-[rgb(44,44,44)] text-white rounded-b-2xl px-3 py-3">
        <h3 class="text-xl font-bold">{{ p.titulo }}</h3>
            <div class="flex flex-col gap-1 mt-1 text-gray-300 text-sm">
            <p class="truncate">üé¨ {{ p['genero'] }}</p>
            </div>
      </div>
    </div>
    {% endfor %}
  </div>
    <div class="text-center mt-8">
    <button
      id="btnMostrarMas"
      class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white text-lg rounded-xl font-semibold translate-y-[25px] transition"
    >
      Mostrar m√°s
    </button>
  </div>
  </section>
  </div>



  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-------------------------------
  <script>
    async function mostrarPelicula(
      titulo,
      duracion,
      sinopsis,
      director,
      genero,
      id_pelicula,
      imagen
    ) {
      const resp = await fetch(`/api/funciones?pelicula=${id_pelicula}`);
      const funciones = await resp.json();

      if (!Array.isArray(funciones) || funciones.length === 0) {
        Swal.fire("Sin funciones disponibles", "", "warning");
        return;
      }

      function formatearFecha(fechaCompleta) {
        const f = new Date(fechaCompleta);
        return (
          f.getDate() + " " + f.toLocaleString("es-ES", { month: "short" })
        );
      }

      function obtenerDiaClave(fechaCompleta) {
        return new Date(fechaCompleta).toISOString().split("T")[0];
      }

      function formatearHora(fechaCompleta) {
        const f = new Date(fechaCompleta);
        return f.toLocaleTimeString("es-ES", {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      // AGRUPAR POR FECHA
      const agrupadas = {};
      funciones.forEach((f) => {
        const clave = obtenerDiaClave(f.fecha_hora);
        if (!agrupadas[clave]) agrupadas[clave] = [];
        agrupadas[clave].push(f);
      });

      // BOTONES DE FECHAS
      let fechasHtml = "";
      for (let clave in agrupadas) {
        fechasHtml += `
      <button class="fecha-btn px-4 py-2 bg-gray-700 rounded hover:bg-red-700"
              data-fecha="${clave}">
        ${formatearFecha(agrupadas[clave][0].fecha_hora)}
      </button>`;
      }

      // MOSTRAR POPUP
      Swal.fire({
        width: "80%",
        background: "#111",
        color: "#fff",
        showConfirmButton: false,
        html: `
      <div class="flex flex-col md:flex-row text-left">

        <div class="md:w-1/3">
          <img src="${imagen}" class="img-card w-60 h-96 object-cover rounded-2xl shadow-lg">
          <div class="flex gap-2">
          <span class="px-3 py-1 bg-gray-700 rounded-full text-sm mt-2 inline-block hover:bg-[#700000] transition">genero: ${genero}</span>
          <span class="px-3 py-1 bg-gray-700 rounded-full text-sm mt-2 inline-block hover:bg-[#700000] transition">director: ${director}</span>
          </div>
        </div>

        <div class="md:w-2/3 md:pl-6">
          <h1 class="text-3xl font-bold text-red-600">${titulo}</h1>
          <p class="text-gray-300 mb-4 leading-relaxed">${sinopsis}</p>

          <h2 class="text-xl font-semibold mb-2">Eleg√≠ una fecha:</h2>

          <div id="contenedor-fechas" class="flex flex-wrap gap-3 mb-6">
            ${fechasHtml}
          </div>

          <div id="contenedor-horarios"></div>
          <div id="contenedor-comprar" class="mt-6"></div>
        </div>

      </div>
    `,
      });

   
      document.addEventListener("click", function listener(e) {
        if (e.target.classList.contains("fecha-btn")) {
          document.querySelectorAll(".fecha-btn").forEach(btn => {
            btn.classList.remove("bg-red-600", "text-white");
            btn.classList.add("bg-gray-700", "text-gray-300");
          });
          e.target.classList.remove("bg-gray-700", "text-gray-300");
          e.target.classList.add("bg-red-600", "text-white");
          document.querySelector("#contenedor-comprar").innerHTML = "";

          const clave = e.target.dataset.fecha;
          const lista = agrupadas[clave];

          let horariosHtml = `
      <h3 class="text-xl font-semibold mb-2">Horarios disponibles:</h3>
      <div class="flex flex-wrap gap-3">
      `;

          lista.forEach((f) => {
            horariosHtml += `
          <button class="hora-btn px-4 py-2 bg-gray-700 rounded hover:bg-red-700"
                  data-id="${f.id_funcion}">
            ${formatearHora(f.fecha_hora)} ¬∑ Sala ${f.id_sala}
          </button>`;
          });

          horariosHtml += "</div>";

          document.querySelector("#contenedor-horarios").innerHTML =
            horariosHtml;
        }

        // CLIC EN HORARIO
        if (e.target.classList.contains("hora-btn")) {
          document.querySelectorAll(".hora-btn").forEach(btn => {
            btn.classList.remove("bg-red-600", "text-white");
            btn.classList.add("bg-gray-700", "text-gray-300");
          });
          e.target.classList.remove("bg-gray-700", "text-gray-300");
          e.target.classList.add("bg-red-600", "text-white");
          document.querySelector("#contenedor-comprar").innerHTML = "";
          const idFuncionSeleccionada = e.target.dataset.id;

        
        document.querySelector("#contenedor-comprar").innerHTML = `
          <div class="flex flex-col gap-2">
            <button id="btnComprar"
            class="mt-4 px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl">
              COMPRAR ENTRADAS
            </button>
            <p id="msgError" class="text-red-500 text-sm font-semibold hidden"></p>
          </div>
          `;

          document.querySelector("#btnComprar").onclick = () => {
                 const username = {{ username|tojson }};
            if (username) {
              window.location.href = `/butacas?pelicula=${id_pelicula}&funcion=${idFuncionSeleccionada}`;
              } else {
                const msg = document.querySelector("#msgError");
                msg.innerHTML = `Necesitas tener una cuenta para comprar entradas,
                  pod√©s iniciar sesi√≥n <a href="/login" class="underline text-red-400">aqu√≠</a>.`;
                msg.classList.remove("hidden");
              }
    };
    }
      });
    }

    // CLICK EN CADA TARJETA
    document.querySelectorAll(".pelicula-cartelera").forEach((card) => {
      card.addEventListener("click", () => {
        mostrarPelicula(
          card.dataset.titulo,
          card.dataset.duracion,
          card.dataset.sinopsis,
          card.dataset.director,
          card.dataset.genero,
          card.dataset.id,
          card.dataset.img
        );
      });
    });
  </script>
  <script>
document.getElementById("filtroGenero").addEventListener("change", function () {
    const generoSeleccionado = this.value.toLowerCase();
    const peliculas = document.querySelectorAll(".card-pelicula");

    peliculas.forEach(card => {
        const generoCard = card.dataset.genero.toLowerCase();

        if (generoSeleccionado === "todos" || generoCard === generoSeleccionado) {
            card.style.display = "block";
        } else {
            card.style.display = "none";
        }
    });
});
</script>
------------->
</body>

{% endblock %}
